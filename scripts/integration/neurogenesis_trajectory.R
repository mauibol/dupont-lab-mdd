# Subset to just astro and GC
#Maddy Peng 

library(Seurat)
library(SeuratObject)
library(SingleCellExperiment)
library(SeuratDisk)
library(Signac)
library(tidyverse)
library(scCustomize)
library(Matrix)
library(BPCells)
library(dplyr)
library(harmony)
library(viridis)
library(future)
library(openxlsx)
library(rio)

# Read in full data
multi <- saveRDS(multi, paste0(MERGED_RDS_PATH, 'multimodal_bpcells.rds'))

# Sub cluster the broad type Astros and GCs 
Idents(multi) <- 'broad_type_leiden'

# Subset just to astros and GNs
keep <- c('Astro', 'GC')
neuro_sub <- subset(multi, subset = broad_type_leiden %in% keep)

# Process and Harmony Integration
neuro_sub <- NormalizeData(neuro_sub)
neuro_sub <- FindVariableFeatures(neuro_sub)
neuro_sub <- ScaleData(neuro_sub)
neuro_sub <- RunPCA(neuro_sub, npcs = 40)

neuro_sub <- RunHarmony(neuro_sub, group.by.vars = c('sample', 'batch', 'ID4'),
                    plot_convergence = T, reduction.save = "harmony.rna")

# Check how many PCs to use
ElbowPlot(neuro_sub, reduction='harmony.rna', ndims=40)

# 20 PCs with resolution of 0.8
neuro_sub <- FindNeighbors(neuro_sub, reduction = "harmony.rna", dims = 1:20)
neuro_sub <- FindClusters(neuro_sub, resolution = 1.0, cluster.name = 'ag_sub_0.8', algorithm=4)
neuro_sub <- RunUMAP(neuro_sub, reduction = "harmony.rna", dims = 1:20, reduction.name = 'harmony.rna.umap', reduction.key = 'HarmonyRnaUMAP_')

#UMAP
DimPlot(neuro_sub, reduction = 'harmony.rna.umap', group.by = 'ag_sub_0.8', raster=F, label=T)
DimPlot(neuro_sub, reduction = 'harmony.rna.umap', group.by = 'broad_type_leiden', raster=F, label=T)


# Markers for dot plot
immature_markers <- c('SOX2', 'PAX6', 'NES', 'ASCL1','S100B','GFAP', 'ETNPPL', 'HES5','AQP4', 'VIM',
                 'FABP7', 'NOTCH1','NOTCH2', 'MKI67', 'MCM2', 'PCNA',  'FOXO3', 'NEUROG2', 'OLIG1', 'OLIG2',
                 'NEUROD1', 'TOP2A', 'EOMES', 'NR2E1', 'MYT1L', 'CALB1', 'CALB2',
                 'RELN', 'DCX', 'STMN2', 'TUBB3', 'PROX1', 'FST', 'BHLHE22', 'POSTN',
                 'RBFOX3', 'SYT1', 'MBP', 'SOX11', 'SOX4','GAD1', 'GAD2', 'SHH', 'PTCH1', 'SMO', 'GLI1', 'GLI2',
                 'HHIP', 'HOXA9', 'HOXB4', 'HOXA10', 'HOXC6','HOXD13', 'BMP2', 'BMP4', 'BMP7','BMPR1A','BMPR1B', 'BMPR2',
                 'NOG', 'GREM1', 'WNT3A', 'WNT5A', 'WNT7A','LRP6','FZD7', 'AXIN2','DVL1','DVL2','CTNNB1')


# This one was generated by chat gpt
genes_by_trajectory <- c(
  # Quiescent Neural Stem Cells (NSCs)
  "SOX2", "PAX6", "NES", "VIM", "ETNPPL", "FABP7", "NOTCH1", "NOTCH2", 
  "HES5", "FOXO3", "NR2E1", "GLI1", "PTCH1", "SMO", 'S100B',
  
  # Early Activated/Proliferative NSCs and Intermediate Progenitors (aNSCs/IPCs)
  "MKI67", "MCM2", "PCNA", "ASCL1", "NEUROG2", "EOMES", "OLIG2", "TOP2A", 
  "DVL1", "DVL2", "CTNNB1", "AXIN2", 
  
  # Neuroblasts / Early Neuronal Differentiation
  "NEUROD1", "MYT1L", "SOX4", "SOX11", "STMN2", "TUBB3", "DCX", "PROX1", 
  "RBFOX3", "SYT1", "CALB2", 
  
  # Immature Granule Cells (postmitotic neuron-like)
  "CALB1", "BHLHE22", "RELN", "FST",  # â† moved FST here
  
  # SHH/BMP/WNT Regulators (expressed across stages or in niche)
  "SHH", "BMP2", "BMP4", "BMP7", "BMPR1A", "BMPR1B", "BMPR2", 
  "NOG", "GREM1", "WNT3A", "WNT5A", "WNT7A", "FZD7", "LRP6",
  
  #Oligo
  'PDGFRA', 'MBP', 'MOG'
)

# Dot plots
DotPlot(neuro_sub, assay='RNA', features = rev(immature_markers), cols = c("yellow","blue"), group.by = 'ag_sub_0.8', cluster.idents = T) + coord_flip() +
  theme(axis.text.x = element_text(angle = 90))

DotPlot(neuro_sub, assay='RNA', features = rev(genes_by_trajectory), cols = c("yellow","blue"), group.by = 'ag_sub_0.8') + coord_flip() +
  theme(axis.text.x = element_text(angle = 90))


# Several iterations of feature plots
FeaturePlot_scCustom(neuro_sub, features=c("SOX2","PAX6", "GFAP", "ETNPPL",'BDNF', 'NEUROG2','NEUROD1',"MKI67", "MCM2", 
                                       "PCNA", "ASCL1", "NEUROG2", "EOMES", 'FST', 'BHLHE22', 'SOX4', 'SOX2', 'SOX11', 'TUBB3', 'DCX', 
                                       'NES','POSTN', 'PROX1', 'NR2E1', 'ASCL1', 'SEMA5A'), reduction = 'harmony.rna.umap')

FeaturePlot_scCustom(neuro_sub, features=c("SOX2","PAX6", 'NES', 'SOX4', 'SOX11', 'ASCL1', 'FABP7', 'LRP6'), reduction = 'harmony.rna.umap')
FeaturePlot_scCustom(neuro_sub, features=c("SOX2","PAX6", 'NES', 'PTCH1', 'GLI1', 'ASCL1'), reduction = 'harmony.rna.umap')
FeaturePlot_scCustom(neuro_sub, features=c('PCNA', 'NEUROD1', 'CDK1', 'MCM2', 'REST', 'MKI67', 'EOMES', 'TOP2A', 'NEUROG2'), reduction = 'harmony.rna.umap')
FeaturePlot_scCustom(neuro_sub, features=c('DCX', 'PROX1', 'CALB2', 'RELN', 'ST8SIA2', 'GLRA2', 'KCNH7', 'EPHA3'), reduction = 'harmony.rna.umap')
FeaturePlot_scCustom(neuro_sub, features=c('BHLHE22', 'STMN1', 'CALB1', 'FST', 'TUBB3', 'POSTN'), reduction = 'harmony.rna.umap')
FeaturePlot_scCustom(neuro_sub, features=c('RBFOX3', 'BDNF', 'STMN1', 'MYT1L', 'SOX1', 'SEMA5A', 'SYT1', 'GRIA1', 'SLC17A7', 'ALDH1L1'), reduction = 'harmony.rna.umap')
FeaturePlot_scCustom(neuro_sub, features=c('GAD1', 'GAD2', 'TAC1', 'NEUROD6', 'CABLES1', 'ETNPPL'), reduction = 'wnn.umap.sub')


# Subcluster cluster 4 -- expressing activated astrocytes and NSC markers
Idents(neuro_sub) <- 'ag_sub_1.0'
neuro_sub <- FindSubCluster(neuro_sub, 4, graph.name = 'RNA_snn', subcluster.name = 'sub4_0.5', algorithm = 4, resolution = 0.4)

# Subcluster cluster 12 -- expressing oligo markers possible doublets
Idents(neuro_sub) <- 'sub4_0.5'
neuro_sub <- FindSubCluster(neuro_sub, 12, graph.name = 'RNA_snn', subcluster.name = 'sub12_0.5', algorithm = 4, resolution = 0.4)

# UMAP plot
DimPlot(imgns, reduction = 'harmony.rna.umap', group.by = 'sub12_0.5', raster=T, label=T)

DotPlot(neuro_sub, assay='RNA', features = rev(immature_markers), 
        cols = c("yellow","blue"), group.by = 'sub12_0.5', cluster.idents = T) + coord_flip() +
  theme(axis.text.x = element_text(angle = 90))

DotPlot(neuro_sub, assay='RNA', features = rev(genes_by_trajectory), 
        cols = c("yellow","blue"), group.by = 'sub12_0.5') + coord_flip() +
  theme(axis.text.x = element_text(angle = 90))

saveRDS(neuro_sub, paste0(MERGED_RDS_PATH, 'neurogenesis_traj_subset.rds'))

# Removing 12_1 and 12_2 which has oligo markers, and running the WNN pipeline
neuro_sub$removed <- neuro_sub$sub12_0.5 %in% c('12_1', '12_2')
neuro_sub <- subset(neuro_sub, subset = removed == FALSE)
meta_sub <- neuro_sub@meta.data

##### WNN ON THE ASTROS AND GNS #############
neuro_sub <- NormalizeData(neuro_sub)
neuro_sub <- FindVariableFeatures(neuro_sub, nfeatures = 2000)
neuro_sub <- ScaleData(neuro_sub)
neuro_sub <- RunPCA(neuro_sub, npcs = 40)

# Harmony integration
neuro_sub <- RunHarmony(neuro_sub, group.by.vars = c('batch', 'ID4','sample'),
                        plot_convergence = T, reduction.save = "harmony.rna", dims.use=1:20)

# Atac processing from bpcells
mtx <- open_matrix_dir(dir=paste0(MERGED_RDS_PATH, 'merged/bpcells_atac'))
mtx <- mtx[, colnames(neuro_sub)]

# Normalize and LSI
mat_lsi <- mtx %>%
  multiply_cols(1 / Matrix::colSums(mtx)) %>%
  multiply_rows(1 / Matrix::rowMeans(mtx))

mat_lsi <- log1p(10000 * mat_lsi)

cell_peak_stats <- matrix_stats(mat_lsi, col_stats="variance")$col_stats
cell_means <- cell_peak_stats["mean",]
cell_vars <- cell_peak_stats["variance",]
mat_lsi_norm <- mat_lsi %>%
  add_cols(-cell_means) %>%
  multiply_cols(1 / cell_vars)

svd_atac <- BPCells::svds(mat_lsi_norm, k=21)
pca_atac <- multiply_cols(svd_atac$v, svd_atac$d)


# Add lsi embedding into Seurat Object
rownames(pca_atac) <- colnames(neuro_sub)
neuro_sub[['lsi']] <- Seurat::CreateDimReducObject(
  embeddings = pca_atac,
  key = "lsi_",
  assay = 'ATAC'
)

# Harmony Integration
neuro_sub <- RunHarmony(neuro_sub, group.by.vars = c('sample', 'batch', 'ID4'), reduction = 'lsi', dims.use = 1:20,
                        plot_convergence = T, reduction.save = "harmony.atac", assay.use = "ATAC", verbose = TRUE, project.dim = FALSE)

# Plot harmony embeddings
ElbowPlot(neuro_sub, reduction='harmony.rna', ndims = 40)


#Multimodal neighbors
neuro_sub <- FindMultiModalNeighbors(
  neuro_sub,
  reduction.list = list('harmony.rna', 'harmony.atac'),
  dims.list = list(1:20, 1:20),
  knn.graph.name = "wknn_sub",
  snn.graph.name = "wsnn_sub",
  modality.weight.name = "RNA.weight",
  verbose = TRUE,
  prune.SNN = 1/20,
  k.nn = 20
)

# Leiden clustering
neuro_sub <- FindClusters(neuro_sub, graph.name = 'wsnn_sub', algorithm = 4, 
                          verbose = T, resolution = 0.8, cluster.name='wnn_sub_0.8',random.seed = 42)

# RunUMAP
neuro_sub <- RunUMAP(
  neuro_sub,
  nn.name='weighted.nn',
  reduction.name='wnn.umap.sub3',
  n.components = 2L,
  min.dist = 0.5,
  seed.use = 42)

# UMAP plot with clusters
DimPlot(neuro_sub, group.by = "wnn_sub_0.8", label = TRUE, repel = F, raster=F, reduction='wnn.umap.sub3', dims = c(1,2))

# Subclustering
Idents(neuro_sub) <- 'wnn_sub_0.8'
neuro_sub <- FindSubCluster(neuro_sub, 4, graph.name = 'wsnn_sub', subcluster.name = 'sub_cluster_13', algorithm = 4, resolution = 0.5)

# INP and NB markers subset
Idents(neuro_sub) <- 'sub_cluster_13'
neuro_sub <- FindSubCluster(neuro_sub, 13, graph.name = 'wsnn_sub', subcluster.name = 'sub_cluster_4', algorithm = 4, resolution = 0.5)


# NSC markers subset cluster
Idents(neuro_sub) <- 'sub_cluster_4'
neuro_sub <- FindSubCluster(neuro_sub, '4_3', graph.name = 'wsnn_sub', subcluster.name = 'sub_cluster_4_3', algorithm = 4, resolution = 0.5)


# Plots
DimPlot(neuro_sub, group.by = "sub_cluster_4_3", label = TRUE, repel = F, raster=F, reduction='wnn.umap.sub2', dims = c(1,2))
DotPlot(neuro_sub, assay='RNA', features = rev(c(imm_markers,'BAMBI','RMST','HSPB8','FABP5','TUBA1A','NEUROD6')), cols = c("yellow","blue"), group.by ='sub_cluster_4_3')+ coord_flip() +
  theme(axis.text.x = element_text(angle = 90))

DotPlot(neuro_sub, assay='RNA', features = rev(c('SOX2','PAX6','NES','ASCL1','HES6','FABP5','FABP7','TUBA1A', 'NEUROD1','NEUROD2',
                                                 'NEUROD6','DCX',"RELN",'CALB2','NELL1','ELMO1','EPHA3','ST8SIA2','CALB1','STMN1','STMN2','NNAT','RMST','SOX11','SOX4',
                                                 'TUBB3','BHLHE22','FST','POSTN','PROX1','VIP','SST','RBFOX3', 'BAMBI')), cols = c("yellow","blue"), group.by ='sub_cluster_4_3')+ coord_flip() +
  theme(axis.text.x = element_text(angle = 90))


#Dendrogram
Idents(neuro_sub) <- 'working_clusters'
embeddings <- Embeddings(object = neuro_sub, reduction = 'pca')
data.dims <- lapply(
  X = levels(neuro_sub),
  FUN = function(x) {
    cells <- WhichCells(object = neuro_sub, expression=working_clusters ==x)
    if (length(x = cells) == 1) {
      cells <- c(cells, cells)
    }
    temp <- colMeans(x = embeddings[cells, ])
  }
)
data.dims <- do.call(what = 'cbind', args = data.dims)
colnames(x = data.dims) <- levels(x = neuro_sub)
data.dist <- dist(x = t(x = data.dims))
data.tree <- ape::as.phylo(x = hclust(d = data.dist, method='complete'))
ape::plot.phylo(x = data.tree, direction = 'downwards')
ape::nodelabels()

neuro_sub <- RunUMAP(
  neuro_sub,
  nn.name='weighted.nn',
  reduction.name='wnn.umap.sub3',
  n.components = 3L,
  seed.use=42,
)


# Isolate the neurogenic clusters of interest and merge other mature clusters
# Merged based on dendrogram above
# Tentative annotations pre diff gene enrichment
neuro_sub$working_clusters <- dplyr::case_when(
  neuro_sub$sub_cluster_4_3 == '4_3_1' ~ 'NSC.b',
  neuro_sub$sub_cluster_4_3 == '4_5' ~ 'NSC.a',
  neuro_sub$sub_cluster_4_3 == '13_1' ~ 'NB',
  neuro_sub$sub_cluster_4_3 %in% c('13_2') ~ 'INP',
  neuro_sub$sub_cluster_4_3 %in% c('9') ~ 'ImGC.1',
  neuro_sub$sub_cluster_4_3 == '8' ~ 'ImGC.2',
  neuro_sub$sub_cluster_4_3 %in% c('6','11','3','17','15') ~ 'mAstro',
  neuro_sub$sub_cluster_4_3 %in% c('4_1','4_3_2','4_4','4_2') ~ 'mAstro',
  neuro_sub$sub_cluster_4_3 %in% c('1','7','5','14') ~ 'mGC',
  neuro_sub$sub_cluster_4_3 %in% c('2','16','10') ~ 'mGC',
  neuro_sub$sub_cluster_4_3 == '12' ~ 'GC.4',
  .default = as.character(neuro_sub$sub_cluster_4_3)
)


DotPlot(neuro_sub, assay='RNA', features = rev(c('SOX2','PAX6','NES','ASCL1','HES6','FABP5','FABP7','TUBA1A', 'NEUROD1','NEUROD2',
                                                 'NEUROD6','TUBB3','STMN1','STMN2','NNAT','DCX',"RELN",'CALB2','NELL1','ELMO1','EPHA3','ST8SIA2','CALB1','RMST','SOX11','SOX4',
                                                 'BHLHE22','FST','POSTN','PROX1','VIP','SST','RBFOX3','PTPRC')), cols = c("yellow","blue"), group.by ='working_clusters')+ coord_flip() +
  theme(axis.text.x = element_text(angle = 90))

DimPlot(neuro_sub, group.by = "working_clusters", label = TRUE, repel = T, raster=F, reduction='wnn.umap.sub2', dims = c(1,2))

# Reorder the factor
anno_level <- c('NSC.a','NSC.b', 'INP','NB','ImGC.1','ImGC.2','mGC','GC.4','mAstro')
neuro_sub$annotations <- factor(neuro_sub$working_clusters, levels=anno_level)

DotPlot(neuro_sub, assay='RNA', features = rev(c('SOX2','PAX6','NES','ASCL1','HES6','SOX11','SOX4','HEY2','RMST','LAMA2','HSPB8','FABP5','FABP7','TMSB4X',
                                                 'NEUROD6','SNCG','STMN1','STMN2','NNAT','TUBB3','CALB2','DCX',"RELN",'NELL1','EPHA3','ST8SIA2',
                                                 'NEUROD1','CALB1','NEUROD2',
                                                 'BHLHE22','FST','POSTN','PROX1','RBFOX3')), cols = c("yellow","blue"), group.by ='annotations2')+ coord_flip() +
  theme(axis.text.x = element_text(angle = 90))


FeaturePlot_scCustom(neuro_sub, reduction = 'wnn.umap.sub3', features=c('SOX2','PAX6','NES','ASCL1','RMST','HEY2','HSPB8','ID3',
                                                                        'SOX4', 'SOX11','PCNA','CDK1','MCM2','MKI67',
                                                                        'EOMES', 'TOP2A','CENPF','NEUROD1','NEUROD6',
                                                                        'DCX','CALB2','RELN','NELL1','ST8SIA2','ST8SIA4','STMN1','STMN2','TUBB3','PROX1',
                                                                        'BHLHE22','CALB1','FST','POSTN'), num_columns = 5)


saveRDS(neuro_sub, paste0(MERGED_RDS_PATH, 'neuro_sub_no_oligo_10.10.25.rds'))

